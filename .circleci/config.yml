version: 2

cwd: &cwd
  working_directory: /usr/local/src

default: &default
  docker:
    - image: buildpack-deps:xenial
  <<: *cwd

jobs:
  checkout:
    <<: *default
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .
  build_web_server:
    <<: *default
    steps:
      - attach_workspace:
          at: /usr/local/src
      - setup_remote_docker
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.06.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin
      - run:
          name: Build Web Server Container
          command: docker build --force-rm --pull -t fleshgrinder/web-server:latest .
  build_web_service:
    <<: *default
    steps:
      - attach_workspace:
          at: /usr/local/src
      - setup_remote_docker
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.06.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin
      - run:
          name: Build Web Service Container
          command: docker build --force-rm --pull -t fleshgrinder/web-service:latest .

workflows:
  version: 2
  pipeline:
    jobs:
      - checkout
      - build_web_server:
          requires:
            - checkout
      - build_web_service:
          requires:
            - checkout

version: 2

jobs:
  checkout:
    docker:
      image: alpine/git
    working_directory: /usr/local/src
    steps:
      - checkout
      - persist_to_workspace:
          root: /usr/local/src
          paths:
            - .

#  build_web_server:
#    docker:
#      image: fleshgrinder/docker-buildpack:17.06.0-ce
#    steps:
#      - attach_workspace:
#          at: /usr/local/src
#      - setup_remote_docker
#      - restore_cache:
#          keys:
#            - web-server-{{ .Branch }}
#          paths:
#            - /var/cache/web-server.tar
#      - run:
#          name: Load Docker Cache
#          command: |
#            set +o pipefail
#            docker load -i /var/cache/web-server.tar | true
#      - run:
#          name: Build Web Server
#          command: |
#            make web-server "WEB_SERVER_TAG=1.0.${CIRCLE_BUILD_NUM}+commit-${CIRCLE_SHA1}"
#            docker images
#      - run:
#          name: Save Docker Cache
#          command: |
#            mkdir -p /var/cache
#            docker save -o /var/cache/web-server.tar fleshgrinder/web-server
#      - save_cache:
#          key: web-server-{{ .Branch }}-{{ epoch }}
#          paths:
#            - /var/cache/web-server.tar
#    working_directory: /usr/local/src
#
#  build_web_service:
#    docker:
#      image: fleshgrinder/docker-buildpack:17.06.0-ce
#    steps:
#      - attach_workspace:
#          at: /usr/local/src
#      - setup_remote_docker
#      - restore_cache:
#          keys:
#            - web-service-{{ .Branch }}
#          paths:
#            - /var/cache/web-service.tar
#      - run:
#          name: Load Docker Cache
#          command: |
#            set +o pipefail
#            docker load -i /var/cache/web-service.tar | true
#      - run:
#          name: Build Web Service
#          command: |
#            make web-service "WEB_SERVICE_TAG=1.0.${CIRCLE_BUILD_NUM}+commit-${CIRCLE_SHA1}"
#            docker images
#      - run:
#          name: Save Docker Cache
#          command: |
#            mkdir -p /var/cache
#            docker save -o /var/cache/web-service.tar fleshgrinder/web-service
#      - save_cache:
#          key: web-service-{{ .Branch }}-{{ epoch }}
#          paths:
#            - /var/cache/web-service.tar
#    working_directory: /usr/local/src

workflows:
  version: 2
  pipeline:
    jobs:
      - checkout
#      - build_web_server:
#          requires:
#            - checkout
#      - build_web_service:
#          requires:
#            - checkout

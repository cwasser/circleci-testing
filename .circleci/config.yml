version: 2

cwd: &cwd
  working_directory: /usr/local/src

default: &default
  docker:
    - image: buildpack-deps:xenial
  <<: *cwd

jobs:
  checkout:
    <<: *default
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .
  build_web_server:
    <<: *default
    steps:
      - attach_workspace:
          at: /usr/local/src
      - setup_remote_docker
      - run:
          name: Install Docker Client
          command: |
            apt-get install -q -y --auto-remove apt-transport-https software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
            add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
            apt-get update -qq
            apt-get install -q -y --auto-remove docker-ce
      - run:
          name: Build Web Server Container
          command: docker build --force-rm --pull -t fleshgrinder/web-server:latest .
  build_web_service:
    <<: *default
    steps:
      - attach_workspace:
          at: /usr/local/src
      - setup_remote_docker
      - run:
          name: Install Docker Client
          command: |
            apt-get install -q -y --auto-remove apt-transport-https software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
            add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
            apt-get update -qq
            apt-get install -q -y --auto-remove docker-ce
      - run:
          name: Build Web Service Container
          command: docker build --force-rm --pull -t fleshgrinder/web-service:latest .

workflows:
  version: 2
  pipeline:
    jobs:
      - checkout
      - build_web_server:
          requires:
            - checkout
      - build_web_service:
          requires:
            - checkout
